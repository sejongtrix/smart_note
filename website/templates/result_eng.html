<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶„ì„ ê²°ê³¼</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container result-page">
        <header class="result-header" style="position:relative;">
            <div class="image-gallery-container">
                <div class="gallery-title">
                    <span class="badge">1</span> Click to 3D Visualize Extracted Images
                </div>
                <div class="image-gallery">
                    <!-- Images will be loaded here by JS -->
                </div>
                <script>
                window.imageFilesFromServer = {{ image_files | tojson }};
                // (ì„ íƒ) ì´ë¯¸ì§€ basePathë¥¼ ì„œë²„ ì„¤ì •ì— ë§ì¶° ì§€ì •
                window.imageBasePathFromServer = "{{ url_for('static', filename='output_images/') }}";
                
                document.addEventListener("DOMContentLoaded", () => {
                    // main.js ì˜ initGalleryê°€ ì¡´ì¬í•˜ë©´ ì´ˆê¸°í™”
                    if (window.initGallery && Array.isArray(window.imageFilesFromServer)) {
                    window.initGallery({ files: window.imageFilesFromServer, basePath: window.imageBasePathFromServer || '/output_images' });
                    // ìë™ ë Œë”ë§ì„ ì›í•˜ë©´ í˜„ì¬ í˜ì´ì§€ ë³€ìˆ˜ ë„£ì–´ í˜¸ì¶œ
                    // ì˜ˆ: window.updateGallery(current_page);
                    }
                });
                </script>
            </div>
        </header>
        <div class="result-body">
            <main class="main-content">
                <div class="slide-view-container">
                     <div class="slide-title">
                        <span class="badge">3</span> pdf slide viewer
                    </div>
                    <div id="slide-image-container">
                    </div>
                </div>
            </main>

            <aside class="right-sidebar">
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-link active" onclick="openTab(event, 'transcript')"><span class="badge">2</span> ëŒ€ë³¸</button>
                        <button class="tab-link" onclick="openTab(event, 'summary')"><span class="badge">4</span> AI ìš”ì•½</button>
                    </div>

                    <div id="transcript" class="tab-content active">
                        <h3>Script of the current page</h3>
                        <div class="transcript-content" id="transcript-content">
                            <!-- JavaScriptë¡œ ë™ì ìœ¼ë¡œ ë Œë”ë§ë  ë‚´ìš© -->
                        </div>
                    </div>
                    <script id="transcript-data" type="application/json">
                        {{ transcript_data.segments | tojson }}
                    </script>

                    <div id="summary" class="tab-content">
                        <h3>AI summary result of current page</h3>
                        <div class="summary-content">
                                <div class="pdf-info">
                                    <p><strong>PDF filename:</strong> {{ pdf_data.filename }}</p>
                                    <p><strong>Total pages:</strong> {{ pdf_data.total_pages }}</p>
                                </div>
                                <div class="pdf-text">
                                    <h4>AI content:</h4>
                                    <div class="ai-content" id="ai-content">
                                        <!-- JavaScriptë¡œ ë™ì ìœ¼ë¡œ ë Œë”ë§ë  ë‚´ìš© -->
                                    </div>
                                    <script id="ai-data" type="application/json">
                                        {{ ai_data | tojson }}
                                    </script>
                                </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <footer class="result-footer">
            <div class="timeline-container">
                <div class="timeline-title">
                    <span class="badge">5</span> Timeline
                </div>
                <div class="timeline-controls" style="position: relative; height: 44px;">
                    <div style="display: flex; align-items: center; width: 100%; position: relative; z-index: 1; margin-top:16px;">
                        <button id="play-toggle">â–¶ï¸</button>
                        <button id="mute-toggle">ğŸ”Š</button>
                        <input 
                            type="range" 
                            id="timeline-slider" 
                            min="0" max="100" value="0" step="0.01"
                            style="flex-grow: 1; margin: 0 10px; height: 10px;"
                        />
                        <span id="slider-tooltip" class="slider-tooltip" hidden>0:00</span>
                        <span id="time-display" style="min-width: 80px;">0:00 / 0:00</span>
                        <audio 
                            id="audio-player"
                            src="{{ url_for('uploaded_file', filename=audio_filename) }}" 
                            style="display:none;"
                        ></audio>
                    </div>
                </div>
                <div id="current-page-display" style="margin-top: 10px; font-size: 16px; text-align: center;">
                    Current page: -
                </div>
            </div>

            <script>
                const audio = document.getElementById('audio-player');
                const playToggle = document.getElementById('play-toggle');
                const muteToggle = document.getElementById('mute-toggle');
                const slider = document.getElementById('timeline-slider');
                const timeDisplay = document.getElementById('time-display');
                const currentPageDisplay = document.getElementById('current-page-display');
                let lastPage = -1;
                function formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                }

                audio.addEventListener('timeupdate', () => {
                const currentTime = audio.currentTime;
                slider.value = (currentTime / audio.duration) * 100 || 0;
                timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(audio.duration)}`;

                // í˜„ì¬ ì¬ìƒ ì‹œê°„ ì„œë²„ë¡œ ì „ì†¡
                fetch('/current_page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ current_time: currentTime })
                })
                .then(response => response.json())
                .then(data => {
                    const currentPage = data.current_page;
                    if (currentPage !== null) {
                        if (currentPage !== lastPage) {
                            console.log(`í˜ì´ì§€ ë³€ê²½ ê°ì§€: ${lastPage} â†’ ${currentPage}`);

                            // í˜ì´ì§€ ë³€ê²½ ì‹œ ì‹¤í–‰í•  í•¨ìˆ˜
                            updateGallery(currentPage+1);
                            updatePage(currentPage);
                            updatePage_ai(currentPage);
                            //updateGallery(currentPage);
                            // ì´ì „ í˜ì´ì§€ ê°±ì‹ 
                            lastPage = currentPage;
                        }
                        currentPageDisplay.textContent = `Current page: ${currentPage}`;

                        // ìŠ¬ë¼ì´ë“œ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                        const slideImageContainer = document.getElementById('slide-image-container');
                        const nextPageNumber = parseInt(currentPage) + 1;
                        const imagePath = `/processed/${nextPageNumber}.png`; // PDF ì´ë¦„ ì—†ì´ ê²½ë¡œ ìƒì„±

                        console.log(`Generated image path: ${imagePath}`); // ë””ë²„ê¹… ë¡œê·¸

                        // ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±°
                        slideImageContainer.innerHTML = '';

                        // ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€
                        const img = document.createElement('img');
                        img.src = imagePath;
                        img.alt = `Page ${currentPage}`;
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';

                        img.onerror = () => console.error(`Failed to load image: ${imagePath}`); // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ë””ë²„ê¹… ë¡œê·¸

                        slideImageContainer.appendChild(img);
                        // updatePage(currentPage);
                    } else {
                        currentPageDisplay.textContent = 'Current page: -';
                    }
                })
                .catch(error => console.error('Error fetching current page:', error));
            });

                playToggle.addEventListener('click', () => {
                    if (audio.paused) {
                        audio.play();
                        playToggle.textContent = 'â¸ï¸';
                    } else {
                        audio.pause();
                        playToggle.textContent = 'â–¶ï¸';
                    }
                });

                muteToggle.addEventListener('click', () => {
                    audio.muted = !audio.muted;
                    muteToggle.textContent = audio.muted ? 'ğŸ”‡' : 'ğŸ”Š';
                });

                slider.addEventListener('input', () => {
                    audio.currentTime = (slider.value / 100) * audio.duration;
                });
            </script>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
