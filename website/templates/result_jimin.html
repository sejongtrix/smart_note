<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Result</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container result-page">
        <header class="result-header" style="position:relative;">
    <button onclick="window.location.href='{{ url_for('result') }}'" style="position:absolute; top:10px; right:20px; z-index:10; padding:6px 16px; border-radius:5px; border:none; background:#1a73e8; color:white; font-weight:bold; cursor:pointer;">ÌïúÍµ≠Ïñ¥</button>
            <div class="image-gallery-container">
                <div class="gallery-title">
                    <span class="badge">1</span> Click to 3D Visualize Extracted Images
                </div>
                <div class="image-gallery">
                    <!-- Images will be loaded here by JS -->
                </div>
                <script>
                window.imageFilesFromServer = {{ image_files | tojson }};
                // (Optional) Set image basePath according to server configuration
                window.imageBasePathFromServer = "{{ url_for('static', filename='output_images/') }}";
                
                document.addEventListener("DOMContentLoaded", () => {
                    // If main.js's initGallery exists, initialize
                    if (window.initGallery && Array.isArray(window.imageFilesFromServer)) {
                    window.initGallery({ files: window.imageFilesFromServer, basePath: window.imageBasePathFromServer || '/output_images' });
                    // For auto rendering, call with current page variable
                    // e.g.: window.updateGallery(current_page);
                    }
                });
                </script>
            </div>
        </header>
        <div class="result-body">
            <main class="main-content">
                <div class="slide-view-container">
                     <div class="slide-title">
                        <span class="badge">3</span> PDF Slide Viewer
                    </div>
                    <div id="slide-image-container">
                    </div>
                </div>
            </main>

            <aside class="right-sidebar">
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-link active" onclick="openTab(event, 'transcript')"><span class="badge">2</span> Transcript</button>
                        <button class="tab-link" onclick="openTab(event, 'summary')"><span class="badge">4</span> AI Summary</button>
                    </div>

                    <div id="transcript" class="tab-content active">
                        <h3>Full Transcript for This Page</h3>
                        <div class="transcript-content" id="transcript-content">
                            <!-- JavaScriptÎ°ú ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅÎê† ÎÇ¥Ïö© -->
                        </div>
                    </div>
                    <script id="transcript-data" type="application/json">
                        {{ transcript_data.segments | tojson }}
                    </script>

                    <div id="summary" class="tab-content">
                        <h3>AI Summary Result</h3>
                        <div class="summary-content">
                                <div class="pdf-info">
                                    <p><strong>PDF Filename:</strong> {{ pdf_data.filename }}</p>
                                    <p><strong>Total Pages:</strong> {{ pdf_data.total_pages }}</p>
                                </div>
                                <div class="pdf-text">
                                    <h4>AI Content:</h4>
                                    <div class="ai-content" id="ai-content">
                                        <!-- JavaScriptÎ°ú ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅÎê† ÎÇ¥Ïö© -->
                                    </div>
                                    <script id="ai-data" type="application/json">
                                        {{ ai_data | tojson }}
                                    </script>
                                </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <footer class="result-footer">
            <div class="timeline-container">
                <div class="timeline-title">
                    <span class="badge">5</span> Timeline
                </div>
                <div class="timeline-controls" style="position: relative; height: 44px;">
                    <div style="display: flex; align-items: center; width: 100%; position: relative; z-index: 1; margin-top:16px;">
                        <button id="play-toggle">‚ñ∂Ô∏è</button>
                        <button id="mute-toggle">üîä</button>
                        <input 
                            type="range" 
                            id="timeline-slider" 
                            min="0" max="100" value="0" step="0.01"
                            style="flex-grow: 1; margin: 0 10px; height: 10px;"
                        />
                        <span id="slider-tooltip" class="slider-tooltip" hidden>0:00</span>
                        <span id="time-display" style="min-width: 80px;">0:00 / 0:00</span>
                        <audio 
                            id="audio-player"
                            src="{{ url_for('uploaded_file', filename=audio_filename) }}" 
                            style="display:none;"
                        ></audio>
                    </div>
                </div>
                <div id="current-page-display" style="margin-top: 10px; font-size: 16px; text-align: center;">
                    ÌòÑÏû¨ ÌéòÏù¥ÏßÄ: -
                </div>
            </div>

            <script>
                const audio = document.getElementById('audio-player');
                const playToggle = document.getElementById('play-toggle');
                const muteToggle = document.getElementById('mute-toggle');
                const slider = document.getElementById('timeline-slider');
                const timeDisplay = document.getElementById('time-display');
                const currentPageDisplay = document.getElementById('current-page-display');
                let lastPage = -1;
                function formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                }

                audio.addEventListener('timeupdate', () => {
                const currentTime = audio.currentTime;
                slider.value = (currentTime / audio.duration) * 100 || 0;
                timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(audio.duration)}`;

                // ÌòÑÏû¨ Ïû¨ÏÉù ÏãúÍ∞Ñ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°
                fetch('/current_page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ current_time: currentTime })
                })
                .then(response => response.json())
                .then(data => {
                    const currentPage = data.current_page;
                    if (currentPage !== null) {
                        if (currentPage !== lastPage) {
                            console.log(`Page change detected: ${lastPage} ‚Üí ${currentPage}`);

                            // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω Ïãú Ïã§ÌñâÌï† Ìï®Ïàò
                            updateGallery(currentPage+1);
                            updatePage(currentPage);
                            updatePage_ai(currentPage);
                            //updateGallery(currentPage);
                            // Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ Í∞±Ïã†
                            lastPage = currentPage;
                        }
                        currentPageDisplay.textContent = `Current Page: ${currentPage}`;

                        // Ïä¨ÎùºÏù¥Îìú Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                        const slideImageContainer = document.getElementById('slide-image-container');
                        const nextPageNumber = parseInt(currentPage) + 1;
                        const imagePath = `/processed/${nextPageNumber}.png`; // Path generated without PDF name

                        console.log(`Generated image path: ${imagePath}`); // Debug log

                        // Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞
                        slideImageContainer.innerHTML = '';

                        // ÏÉà Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä
                        const img = document.createElement('img');
                        img.src = imagePath;
                        img.alt = `Page ${currentPage}`;
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';

                        img.onerror = () => console.error(`Failed to load image: ${imagePath}`); // Image load failure debug log

                        slideImageContainer.appendChild(img);
                        // updatePage(currentPage);
                    } else {
                        currentPageDisplay.textContent = 'Current Page: -';
                    }
                })
                .catch(error => console.error('Error fetching current page:', error));
            });

                playToggle.addEventListener('click', () => {
                    if (audio.paused) {
                        audio.play();
                        playToggle.textContent = '‚è∏Ô∏è';
                    } else {
                        audio.pause();
                        playToggle.textContent = '‚ñ∂Ô∏è';
                    }
                });

                muteToggle.addEventListener('click', () => {
                    audio.muted = !audio.muted;
                    muteToggle.textContent = audio.muted ? 'üîá' : 'üîä';
                });

                slider.addEventListener('input', () => {
                    audio.currentTime = (slider.value / 100) * audio.duration;
                });
            </script>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
